{% extends "user/layout.html" %}

{% block title %}Dashboard - Zemingo AI Image Generator{% endblock %}

{% block head %}
<style>
    .generator-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        margin-top: 10px;
    }
    
    .form-section {
        background-color: var(--surface);
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .prompt-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    label {
        font-weight: 500;
    }
    
    textarea {
        background-color: var(--surface-light);
        border: 1px solid #333;
        border-radius: 4px;
        padding: 12px;
        color: var(--text);
        font-family: 'Rubik', sans-serif;
        font-size: 16px;
        resize: vertical;
        min-height: 100px;
    }
    
    .model-select {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .model-option {
        background-color: var(--surface-light);
        border: 2px solid transparent;
        border-radius: 6px;
        padding: 15px;
        cursor: pointer;
        flex: 1;
        min-width: 200px;
        transition: border-color 0.2s, transform 0.2s;
    }
    
    .model-option:hover {
        transform: translateY(-2px);
    }
    
    .model-option.selected {
        border-color: var(--primary-light);
    }
    
    .model-name {
        font-weight: 600;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }
    
    .info-icon {
        margin-left: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: var(--primary-light);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .info-icon:after {
        content: 'i';
        color: white;
        font-size: 10px;
        font-weight: 600;
        font-family: Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }
    
    .info-icon:hover {
        background-color: var(--primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .premium-badge {
        margin-left: 8px;
        background-color: gold;
        color: #333;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .model-description {
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
    }
    
    .generate-btn {
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px 25px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .generate-btn:hover {
        background-color: #7722ff;
    }
    
    .generate-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }
    
    .usage-info {
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .results-section {
        background-color: var(--surface);
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .results-section h2 {
        margin-top: 0;
        margin-bottom: 20px;
    }
    
    .image-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
    }
    
    .image-container {
        position: relative;
        background-color: var(--surface-light);
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 1 / 1;
    }
    
    .generated-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }
    
    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: transparent;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .image-container:hover .image-overlay {
        opacity: 1;
    }
    
    .image-container:hover .generated-image {
        transform: scale(1.05);
    }
    
    .download-icon {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: var(--primary);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    
    .download-icon:hover {
        background-color: #7722ff;
    }
    
    .loading-placeholder {
        width: 100%;
        height: 100%;
        background: linear-gradient(-45deg, var(--surface-light) 25%, var(--surface) 50%, var(--surface-light) 75%);
        background-size: 400% 400%;
        animation: shimmer 2s infinite;
        border-radius: 8px;
    }
    
    .loading-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--text-secondary);
    }
    
    @keyframes shimmer {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    .no-results {
        text-align: center;
        color: var(--text-secondary);
        padding: 40px 0;
    }
    
    @media (max-width: 768px) {
        .image-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* Modal styles */
    .model-info-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        overflow-y: auto;
    }
    
    .modal-content {
        background-color: var(--surface);
        margin: 50px auto;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        position: relative;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .close-modal:hover {
        color: var(--text);
    }
    
    .model-info-content h2 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--primary-light);
        font-size: 28px;
    }
    
    .info-section {
        margin-bottom: 25px;
        line-height: 1.6;
    }
    
    .info-section h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--text);
    }
    
    .info-section p {
        margin-bottom: 10px;
        line-height: 1.6;
    }
    
    .info-section ul {
        padding-left: 20px;
        margin-bottom: 10px;
    }
    
    .info-section li {
        margin-bottom: 8px;
    }
    
    /* Emoji styling */
    .info-section br + br {
        content: '';
        display: block;
        margin-top: 15px;
    }
    
    /* Highlight sections with emoji headers */
    .info-section br:first-child {
        display: none;
    }
    
    /* Style list markers */
    .info-section:not(h3) {
        font-size: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-title">
    <h1>AI Image Generator</h1>
</div>

{% if not api_configured %}
<div class="flash-message flash-error">
    <strong>API Not Configured:</strong> The FAL API key is not set up. Please contact the administrator to configure the API key for image generation to work.
</div>
{% endif %}

<div class="generator-container">
    <div class="form-section">
        <form id="promptForm" class="prompt-form">
            <div class="form-group">
                <label for="prompt">Describe what you want to see in detail:</label>
                <textarea id="prompt" name="prompt" required 
                    placeholder="e.g., A futuristic city skyline with flying cars and neon lights, photorealistic, detailed, 8k"></textarea>
            </div>
            
            <div class="form-group">
                <label>Select an AI model:</label>
                <div class="model-select">
                    {% for model_id, model in models.items() %}
                    <div class="model-option {% if model_id == 'flux' %}selected{% endif %}" data-model="{{ model_id }}" data-is-pro="{{ 'true' if model_id == 'flux_pro' else 'false' }}">
                        <div class="model-name">
                            {{ model.name }}
                            {% if 'pro' in model_id %}
                            <span class="premium-badge">Pro</span>
                            {% endif %}
                            {% if model.detailed_info is defined %}
                            <span class="info-icon" data-model-id="{{ model_id }}">
                            </span>
                            {% endif %}
                        </div>
                        <div class="model-description">{{ model.description if model.description else "Text-to-image generation model" }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" id="generateBtn" class="generate-btn">Generate 4 Images</button>
                <div class="usage-info">
                    Your usage this month: <strong>{{ current_usage }}</strong> images
                </div>
            </div>
        </form>
    </div>
    
    <div class="results-section">
        <h2>Generated Images</h2>
        
        <div id="results" class="image-grid">
            <div class="no-results">
                Enter a prompt above and click "Generate" to create images
            </div>
        </div>
    </div>
</div>

<!-- Model Information Modal -->
<div id="modelInfoModal" class="model-info-modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="model-info-content">
            <h2 id="modalModelName"></h2>
            <div id="modalModelContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const promptForm = document.getElementById('promptForm');
        const generateBtn = document.getElementById('generateBtn');
        const resultsContainer = document.getElementById('results');
        const modelOptions = document.querySelectorAll('.model-option');
        const infoIcons = document.querySelectorAll('.info-icon');
        const modelInfoModal = document.getElementById('modelInfoModal');
        const modalModelName = document.getElementById('modalModelName');
        const modalModelContent = document.getElementById('modalModelContent');
        const closeModal = document.querySelector('.close-modal');
        let selectedModel = 'flux'; // Default model
        let isProModel = false; // Track if selected model is Pro
        
        // Handle model info icon clicks
        infoIcons.forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering model selection
                const modelId = this.dataset.modelId;
                
                // Fetch model info from server
                fetch(`/api/model-info/${modelId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.name) {
                            // Set modal content
                            modalModelName.textContent = data.name;
                            
                            // Build content sections
                            let contentHTML = '';
                            
                            if (data.info.what_is) {
                                contentHTML += `<div class="info-section">
                                    ${data.info.what_is.replace(/\n/g, '<br>')}
                                </div>`;
                            }
                            
                            if (data.info.use_cases) {
                                contentHTML += `<div class="info-section">
                                    ${data.info.use_cases.replace(/\n/g, '<br>')}
                                </div>`;
                            }
                            
                            if (data.info.tips) {
                                contentHTML += `<div class="info-section">
                                    ${data.info.tips.replace(/\n/g, '<br>')}
                                </div>`;
                            }
                            
                            // Set HTML content directly to render links
                            modalModelContent.innerHTML = contentHTML;
                            
                            // Add target="_blank" and rel="noopener noreferrer" to all links for security
                            modalModelContent.querySelectorAll('a').forEach(link => {
                                if (!link.hasAttribute('target')) {
                                    link.setAttribute('target', '_blank');
                                }
                                link.setAttribute('rel', 'noopener noreferrer');
                                
                                // Style links
                                link.style.color = 'var(--primary-light)';
                                link.style.textDecoration = 'underline';
                                link.style.fontWeight = '500';
                            });
                            
                            // Show modal
                            modelInfoModal.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching model info:', error);
                    });
            });
        });
        
        // Close modal events
        closeModal.addEventListener('click', function() {
            modelInfoModal.style.display = 'none';
        });
        
        window.addEventListener('click', function(e) {
            if (e.target === modelInfoModal) {
                modelInfoModal.style.display = 'none';
            }
        });
        
        // Handle model selection
        modelOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                modelOptions.forEach(opt => opt.classList.remove('selected'));
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Update selected model
                selectedModel = this.dataset.model;
                isProModel = this.dataset.isPro === 'true';
                
                // Update button text
                if (isProModel) {
                    generateBtn.textContent = 'Generate 1 Premium Image';
                } else {
                    generateBtn.textContent = 'Generate 4 Images';
                }
            });
        });
        
        // Select the first model option by default
        if (modelOptions.length > 0 && !document.querySelector('.model-option.selected')) {
            modelOptions[0].click();
        }
        
        // Populate prompt from URL parameter if present
        const urlParams = new URLSearchParams(window.location.search);
        const promptParam = urlParams.get('prompt');
        if (promptParam) {
            document.getElementById('prompt').value = promptParam;
        }
        
        // Handle form submission
        promptForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const prompt = document.getElementById('prompt').value.trim();
            
            if (!prompt) {
                alert('Please enter a prompt');
                return;
            }
            
            // Disable button and show loading state
            generateBtn.disabled = true;
            generateBtn.textContent = isProModel ? 'Generating Premium Image...' : 'Generating...';
            
            // Show loading placeholders
            resultsContainer.innerHTML = '';
            
            // For Pro models, only show one placeholder
            const placeholdersCount = isProModel ? 1 : 4;
            
            for (let i = 0; i < placeholdersCount; i++) {
                resultsContainer.innerHTML += `
                    <div class="image-container">
                        <div class="loading-placeholder"></div>
                        <div class="loading-text">Generating${isProModel ? ' Premium Image' : ''}...</div>
                    </div>
                `;
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('prompt', prompt);
            formData.append('model', selectedModel);
            
            // For non-Pro models, request 4 images
            if (!isProModel) {
                formData.append('num_images', 4);
            }
            
            try {
                // Send request to API
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate images');
                }
                
                // Display results
                displayResults(data.image_urls);
                
            } catch (error) {
                alert('Error: ' + error.message);
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        Error: ${error.message}
                    </div>
                `;
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                generateBtn.textContent = isProModel ? 'Generate 1 Premium Image' : 'Generate 4 Images';
            }
        });
        
        // Function to display results
        function displayResults(imageUrls) {
            if (!imageUrls || imageUrls.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        No images were generated. Please try again.
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            imageUrls.forEach(url => {
                const filename = url.split('/').pop().split('?')[0];
                
                resultsContainer.innerHTML += `
                    <div class="image-container">
                        <img src="${url}" alt="Generated image" class="generated-image">
                        <div class="image-overlay">
                            <a href="${url}" download="${filename}" class="download-icon">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    </div>
                `;
            });
        }
    });
</script>
{% endblock %} 