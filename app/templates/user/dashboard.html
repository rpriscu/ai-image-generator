{% extends "user/layout.html" %}

{% block title %}Generator - Zemingo AI Asset Generator{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-title">
    <h1>AI Asset Generator</h1>
</div>

{% if not api_configured %}
<div class="flash-message flash-error">
    <strong>API Not Configured:</strong> The FAL API key is not set up. Please contact the administrator to configure the API key for asset generation to work.
</div>
{% endif %}

<div class="generator-container">
    <div class="form-section">
        <form id="promptForm" class="prompt-form" enctype="multipart/form-data">
            <div class="form-group" id="promptSection">
                <label for="prompt">Describe what you want to see in detail:</label>
                <textarea id="prompt" name="prompt" 
                    placeholder="e.g., A futuristic city skyline with flying cars and neon lights, photorealistic, detailed, 8k"></textarea>
                <small id="promptNotRequired" style="display: none; color: #aaa;">
                    This model doesn't require a prompt, only an input image.
                </small>
            </div>
            
            <div class="form-group" id="imageUploadSection" style="display: none;">
                <label for="image" id="imageUploadLabel">Reference Image <span id="optionalImageText">(Optional)</span>:</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="image" name="image" accept="image/*" class="file-upload-input">
                    <div class="file-upload-label">
                        <span class="file-upload-text">Choose an image...</span>
                        <span class="file-upload-button">Browse</span>
                    </div>
                </div>
                <div class="preview-container" style="display: none;">
                    <img id="imagePreview" alt="Preview" style="max-width: 100%; max-height: 200px; margin-top: 10px;">
                    <button type="button" id="removeImageBtn" class="remove-btn">✕</button>
                </div>
                <p class="file-hint">For image-to-image generation, you can upload a reference image to guide the model.</p>
            </div>
            
            <div class="form-group" id="maskUploadSection" style="display: none;">
                <label for="maskImage">Mask Image (Required for Fill):</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="maskImage" name="mask" accept="image/*" class="file-upload-input">
                    <div class="file-upload-label">
                        <span class="file-upload-text">Choose a mask image...</span>
                        <span class="file-upload-button">Browse</span>
                    </div>
                </div>
                <div class="preview-container mask-preview-container">
                    <img id="maskPreview" alt="Mask Preview" style="max-width: 100%; max-height: 200px; display: none;">
                    <button type="button" id="removeMaskBtn" class="remove-btn" style="display: none;">✕</button>
                </div>
                <small class="form-text text-muted">
                    <strong>Mask Requirements:</strong> 
                    <ul>
                        <li>White areas (255, 255, 255) will be filled with generated content</li>
                        <li>Black areas (0, 0, 0) will preserve the original image</li>
                        <li>The mask must have the same dimensions (width x height) as the reference image</li>
                    </ul>
                </small>
            </div>
            
            <div class="form-group" id="sdParamsSection" style="display: none;">
                <label>Stable Diffusion Parameters:</label>
                <div class="sd-params-grid">
                    <!-- Left column: Negative prompt and other text inputs -->
                    <div class="sd-params-column">
                        <div class="param-group">
                            <label for="negative_prompt">Negative Prompt:</label>
                            <textarea id="negative_prompt" name="negative_prompt" style="min-height: 92px;"
                                placeholder="Describe what you don't want to see in the image"></textarea>
                        </div>
                        <div class="param-group" style="margin-top: 15px;">
                            <label for="seed">Seed (Optional):</label>
                            <input type="number" id="seed" name="seed" placeholder="Leave empty for random">
                        </div>
                    </div>
                    
                    <!-- Right column: All sliders -->
                    <div class="sd-params-column slider-column">
                        <div class="param-group slider-group" style="margin-bottom: 8px;">
                            <label for="strength">Strength:</label>
                            <div class="slider-container" style="margin-bottom: 8px;">
                                <input type="range" id="strength" name="strength" min="0" max="1" step="0.05" value="0.75">
                                <span class="param-value">0.75</span>
                            </div>
                        </div>
                        <div class="param-group slider-group" style="margin-bottom: 8px;">
                            <label for="guidance_scale">Guidance Scale:</label>
                            <div class="slider-container" style="margin-bottom: 8px;">
                                <input type="range" id="guidance_scale" name="guidance_scale" min="1" max="20" step="0.5" value="7.5">
                                <span class="param-value">7.5</span>
                            </div>
                        </div>
                        <div class="param-group slider-group">
                            <label for="num_inference_steps">Inference Steps:</label>
                            <div class="slider-container" style="margin-bottom: 8px;">
                                <input type="range" id="num_inference_steps" name="num_inference_steps" min="1" max="50" step="1" value="30">
                                <span class="param-value">30</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Select an AI model:</label>
                <div class="model-select">
                    {% for model_id, model in models.items() %}
                    <div class="model-option {% if model_id == 'flux' %}selected{% endif %}" data-model="{{ model_id }}" data-is-pro="{{ 'true' if model_id == 'flux_pro' else 'false' }}" onclick="selectModel('{{ model_id }}', {{ 'true' if model_id == 'flux_pro' else 'false' }}, this)">
                        <div class="model-name">
                            {{ model.name }}
                            {% if 'pro' in model_id %}
                            <span class="premium-badge">Pro</span>
                            {% endif %}
                            {% if model.detailed_info is defined %}
                            <span class="info-icon" data-model-id="{{ model_id }}" onclick="event.stopPropagation(); showModelInfo('{{ model_id }}')">
                            </span>
                            {% endif %}
                        </div>
                        <div class="model-description">{{ model.description if model.description else "Text-to-image generation model" }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" id="generateBtn" class="generate-btn">Generate 4 Assets</button>
                <div class="usage-info">
                    Your usage this month: <strong>{{ current_usage }}</strong> assets
                </div>
            </div>
        </form>
    </div>
    
    <div class="results-section">
        <h2>Generated Assets</h2>
        
        <div id="results" class="image-grid">
            <div class="no-results">
                Enter a prompt above and click "Generate" to create assets
            </div>
        </div>
    </div>
</div>

<!-- Model Information Modal -->
<div id="modelInfoModal" class="model-info-modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="model-info-content">
            <h2 id="modalModelName"></h2>
            <div id="modalModelContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include the Model UI Manager -->
<script src="{{ url_for('static', filename='js/model-ui-manager.js') }}"></script>
<!-- Include the Dashboard API module -->
<script src="{{ url_for('static', filename='js/dashboard-api.js') }}"></script>
<!-- Include the Generation State Manager -->
<script src="{{ url_for('static', filename='js/generation-state-manager.js') }}"></script>
<!-- Include the Progress Recovery Manager -->
<script src="{{ url_for('static', filename='js/progress-recovery-manager.js') }}"></script>

<script>
    // Model configurations from backend - passed as JSON
    const modelConfigs = {{ models | tojson | safe }};
    
    // Initialize the UI manager
    const uiManager = new ModelUIManager(modelConfigs);
    
    // Initialize the state management system
    const stateManager = new GenerationStateManager();
    const progressRecovery = new ProgressRecoveryManager(stateManager, uiManager);
    
    // Global reference for other functions
    window.stateManager = stateManager;
    window.progressRecovery = progressRecovery;
    
    // Simplified model selection function
    function selectModel(modelId, isPro, element) {
        try {
            // Update selected UI
            document.querySelectorAll('.model-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            
            // Use UI manager to update interface
            uiManager.updateUI(modelId);
            
        } catch (error) {
            console.error('Error in selectModel:', error);
        }
    }
    
    // Show model info in modal
    async function showModelInfo(modelId) {
        try {
            console.log(`Showing info for model: ${modelId}`);
            
            // Use DashboardAPI to fetch model info
            const data = await DashboardAPI.getModelInfo(modelId);
            
            if (data && data.name) {
                // Set modal content
                document.getElementById('modalModelName').textContent = data.name;
                
                // Build content sections
                let contentHTML = '';
                
                if (data.info.what_is) {
                    contentHTML += `<div class="info-section">
                        ${data.info.what_is.replace(/\n/g, '<br>')}
                    </div>`;
                }
                
                if (data.info.use_cases) {
                    contentHTML += `<div class="info-section">
                        ${data.info.use_cases.replace(/\n/g, '<br>')}
                    </div>`;
                }
                
                if (data.info.tips) {
                    contentHTML += `<div class="info-section">
                        ${data.info.tips.replace(/\n/g, '<br>')}
                    </div>`;
                }
                
                // Set HTML content directly to render links
                document.getElementById('modalModelContent').innerHTML = contentHTML;
                
                // Style links
                document.getElementById('modalModelContent').querySelectorAll('a').forEach(link => {
                    if (!link.hasAttribute('target')) {
                        link.setAttribute('target', '_blank');
                    }
                    link.setAttribute('rel', 'noopener noreferrer');
                    link.style.color = 'var(--primary-light)';
                    link.style.textDecoration = 'underline';
                    link.style.fontWeight = '500';
                });
                
                // Show modal
                document.getElementById('modelInfoModal').style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching model info:', error);
        }
    }
    
    // Function to set reference image
    async function setReferenceImage(imageUrl) {
        try {
            console.log('[setReferenceImage] Starting with URL:', imageUrl);
            
            // Make sure image upload section is visible
            const imageUploadSection = document.getElementById('imageUploadSection');
            if (!imageUploadSection) {
                console.error('[setReferenceImage] Could not find imageUploadSection element');
                return false;
            }
            
            console.log('[setReferenceImage] Setting imageUploadSection display:', 'block');
            imageUploadSection.style.display = 'block';
            
            // Use DashboardAPI to load image as file
            const file = await DashboardAPI.loadImageAsFile(imageUrl);
            
            // Create a DataTransfer object to set the file input value
            console.log('[setReferenceImage] Creating DataTransfer object...');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            
            // Set the file input value
            const fileInput = document.getElementById('image');
            if (!fileInput) {
                console.error('[setReferenceImage] Could not find image input element');
                return false;
            }
            
            console.log('[setReferenceImage] Setting file input...');
            fileInput.files = dataTransfer.files;
            
            // Update the file text display
            const fileText = document.querySelector('.file-upload-text');
            if (fileText) {
                console.log('[setReferenceImage] Updating file text display...');
                fileText.textContent = file.name;
            }
            
            // Set the preview image
            const imagePreview = document.getElementById('imagePreview');
            const previewContainer = document.querySelector('.preview-container');
            
            if (imagePreview && previewContainer) {
                console.log('[setReferenceImage] Setting preview image...');
                const objectUrl = URL.createObjectURL(file);
                imagePreview.src = objectUrl;
                previewContainer.style.display = 'block';
            }
            
            console.log('[setReferenceImage] Reference image set successfully');
            
            // Dispatch change event
            console.log('[setReferenceImage] Dispatching change event...');
            const changeEvent = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(changeEvent);
            
            return true;
        } catch (error) {
            console.error('[setReferenceImage] Error:', error);
            return false;
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Set up modal close handlers
        document.querySelector('.close-modal').addEventListener('click', function() {
            document.getElementById('modelInfoModal').style.display = 'none';
        });
        
        window.addEventListener('click', function(e) {
            if (e.target === document.getElementById('modelInfoModal')) {
                document.getElementById('modelInfoModal').style.display = 'none';
            }
        });
        
        // Handle range input value updates
        document.querySelectorAll('input[type="range"]').forEach(input => {
            const valueDisplay = input.nextElementSibling;
            input.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
            });
        });
        
        // Handle file upload display for the main image
        document.getElementById('image').addEventListener('change', function() {
            const fileText = this.closest('.file-upload-wrapper').querySelector('.file-upload-text');
            const previewContainer = this.closest('.form-group').querySelector('.preview-container');
            const imagePreview = this.closest('.form-group').querySelector('img[id^="imagePreview"]'); // More robust selector
            const removeBtn = this.closest('.form-group').querySelector('.remove-btn');

            if (this.files && this.files[0]) {
                const file = this.files[0];
                fileText.textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    previewContainer.style.display = 'block';
                    if(removeBtn) removeBtn.style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            } else {
                fileText.textContent = 'Choose an image...';
                imagePreview.src = '#';
                previewContainer.style.display = 'none';
                if(removeBtn) removeBtn.style.display = 'none';
            }
        });
        
        // Handle file upload display for the mask image
        const maskInput = document.getElementById('maskImage');
        if (maskInput) {
            maskInput.addEventListener('change', function() {
                const fileText = this.closest('.file-upload-wrapper').querySelector('.file-upload-text');
                const previewContainer = this.closest('.form-group').querySelector('.mask-preview-container');
                const maskPreview = this.closest('.form-group').querySelector('#maskPreview');
                const removeBtn = this.closest('.form-group').querySelector('#removeMaskBtn');

                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    fileText.textContent = file.name;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        maskPreview.src = e.target.result;
                        maskPreview.style.display = 'block'; // Make sure preview img is visible
                        if(previewContainer) previewContainer.style.display = 'block'; // Make sure container is visible
                        if(removeBtn) removeBtn.style.display = 'inline-block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    fileText.textContent = 'Choose a mask image...';
                    maskPreview.src = '#';
                    maskPreview.style.display = 'none';
                    if(previewContainer) previewContainer.style.display = 'none';
                    if(removeBtn) removeBtn.style.display = 'none';
                }
            });
        }
        
        // Handle URL parameters for regeneration
        const urlParams = new URLSearchParams(window.location.search);
        const prompt = urlParams.get('prompt');
        const useReferenceImage = urlParams.get('useReferenceImage') === 'true';
        const modelParam = urlParams.get('model');
        
        // Set prompt if provided
        if (prompt) {
            document.getElementById('prompt').value = prompt;
        }
        
        // Function to ensure proper model settings and UI are applied
        const applyModelSettings = async () => {
            // First, select the correct model if specified in URL
            if (modelParam) {
                const modelOption = document.querySelector(`.model-option[data-model="${modelParam}"]`);
                if (modelOption) {
                    const modelId = modelOption.dataset.model;
                    const isPro = modelOption.dataset.isPro === 'true';
                    
                    // Update selected UI
                    document.querySelectorAll('.model-option').forEach(el => el.classList.remove('selected'));
                    modelOption.classList.add('selected');
                    
                    // Apply model settings
                    selectModel(modelId, isPro, modelOption);
                    
                    // If we need to load a reference image, ensure the image section is visible
                    if (useReferenceImage) {
                        const imageUploadSection = document.getElementById('imageUploadSection');
                        imageUploadSection.style.display = 'block';
                    }
                }
            } else {
                // No URL parameter, initialize the default selected model
                const defaultSelectedModel = document.querySelector('.model-option.selected');
                if (defaultSelectedModel) {
                    const modelId = defaultSelectedModel.dataset.model;
                    const isPro = defaultSelectedModel.dataset.isPro === 'true';
                    
                    console.log('Initializing default model UI:', modelId);
                    // Initialize UI for the default selected model
                    uiManager.updateUI(modelId);
                }
            }
            
            // Then, if there's a reference image URL in localStorage, load it
            if (useReferenceImage) {
                const referenceImageUrl = localStorage.getItem('referenceImageUrl');
                if (referenceImageUrl) {
                    try {
                        // Force image upload section to be visible before loading the image
                        document.getElementById('imageUploadSection').style.display = 'block';
                        
                        // Add a small delay to ensure UI is ready
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Load the reference image
                        const success = await setReferenceImage(referenceImageUrl);
                        
                        // Clear localStorage after loading to prevent unintended reuse
                        localStorage.removeItem('referenceImageUrl');
                        
                        if (success) {
                            console.log('Reference image loaded successfully for regeneration');
                        } else {
                            console.error('Failed to set reference image, but no exception was thrown');
                        }
                    } catch (error) {
                        console.error('Failed to load reference image:', error);
                    }
                }
            }
        };
        
        // Apply model settings and load reference image with proper timing
        applyModelSettings();
        
        // Initialize progress recovery system
        progressRecovery.initialize().catch(error => {
            console.error('[Dashboard] Error initializing progress recovery:', error);
        });
    });

    // Function to handle form submission
    document.getElementById('promptForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get selected model
        const selectedModelOption = document.querySelector('.model-option.selected');
        if (!selectedModelOption) {
            showError('Please select a model');
            return;
        }
        
        const modelId = selectedModelOption.dataset.model;
        const isPro = selectedModelOption.dataset.isPro === 'true';
        const model = modelConfigs[modelId];
        
        console.log('Form submitted with model:', modelId);
        
        // Check if prompt is required and present
        const promptElement = document.getElementById('prompt');
        const prompt = promptElement ? promptElement.value.trim() : '';
        
        if (model && model.ui_config && model.ui_config.prompt_required !== false && !prompt) {
            showError('Please enter a prompt');
            return;
        }
        
        // For stable_video, check if image is uploaded
        if (modelId === 'stable_video') {
            const imageInput = document.getElementById('image');
            console.log('Checking stable_video image upload...');
            if (!imageInput || !imageInput.files || !imageInput.files[0]) {
                console.log('No image uploaded for stable_video');
                showError('Please upload an image for video generation');
                return;
            }
            console.log('Image found for stable_video:', imageInput.files[0].name);
        }
        
        // For flux_pro (fill), check if both image and mask are uploaded
        if (modelId === 'flux_pro') {
            const imageInput = document.getElementById('image');
            const maskInput = document.getElementById('maskImage');
            if (!imageInput || !imageInput.files || !imageInput.files[0]) {
                showError('Please upload a reference image');
                return;
            }
            if (!maskInput || !maskInput.files || !maskInput.files[0]) {
                showError('Please upload a mask image');
                return;
            }
        }
        
        // Create form data
        const formData = new FormData(this);
        
        // Add model ID to form data
        formData.append('model', modelId);
        
        // Use the extracted generation logic
        await handleGeneration(formData, modelId);
    });
    
    // Function to display generation results
    function displayResults(results, modelId) {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = '';
        
        console.log('Displaying results:', results, 'for model:', modelId);
        
        if (!results || results.length === 0) {
            resultsContainer.innerHTML = '<div class="no-results">No results were generated. Please try again.</div>';
            return;
        }
        
        results.forEach(result => {
            console.log('Processing result:', result);
            
            if (!result.url) {
                console.error('Result missing URL:', result);
                return;
            }
            
            if (modelId === 'stable_video' || result.type === 'video') {
                // Display video result
                const videoElement = document.createElement('div');
                videoElement.className = 'video-result';
                videoElement.innerHTML = `
                    <video src="${result.url}" controls autoplay loop muted></video>
                    <div class="image-actions">
                        <button class="download-btn" onclick="downloadAsset(${result.id}, '${result.url}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="delete-btn" onclick="deleteAsset(${result.id}, this.parentNode.parentNode)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                resultsContainer.appendChild(videoElement);
                console.log('Added video element to results container');
            } else {
                // Display image result
                const imageElement = document.createElement('div');
                imageElement.className = 'image-result';
                
                // Preload the image to verify it loads
                const img = new Image();
                img.onload = function() {
                    console.log('Image loaded successfully:', result.url);
                };
                img.onerror = function() {
                    console.error('Error loading image:', result.url);
                    imageElement.classList.add('error');
                    imageElement.innerHTML = `
                        <div class="error-message">
                            Image failed to load<br>
                            <small>${result.url}</small>
                        </div>
                    `;
                };
                img.src = result.url;
                
                imageElement.innerHTML = `
                    <img src="${result.url}" alt="Generated image" onerror="this.onerror=null; this.parentNode.classList.add('error'); this.parentNode.innerHTML='<div class=\\'error-message\\'>Image failed to load</div>';">
                    <div class="image-actions">
                        <button class="refine-btn" onclick="refineImage('${result.url}')">
                            <i class="fas fa-magic"></i>
                        </button>
                        <button class="video-btn" onclick="generateVideo('${result.url}')">
                            <i class="fas fa-film"></i>
                        </button>
                        <button class="download-btn" onclick="downloadAsset(${result.id}, '${result.url}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="delete-btn" onclick="deleteAsset(${result.id}, this.parentNode.parentNode)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                resultsContainer.appendChild(imageElement);
                console.log('Added image element to results container');
            }
        });
    }
    
    // Function to refine an image (use as reference for new generation)
    function refineImage(imageUrl) {
        // Set the image URL in the reference image input
        setReferenceImage(imageUrl).then(() => {
            // Make sure image upload section is visible
            document.getElementById('imageUploadSection').style.display = 'block';
            
            // Scroll to the top of the form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        });
    }
    
    // Function to generate a video from an image
    function generateVideo(imageUrl) {
        console.log('Generating video from image:', imageUrl);
        
        // Store the reference image URL in localStorage
        localStorage.setItem('referenceImageUrl', imageUrl);
        
        // Find the stable_video model option
        const stableVideoOption = document.querySelector('.model-option[data-model="stable_video"]');
        if (stableVideoOption) {
            // Get model attributes
            const modelId = stableVideoOption.dataset.model;
            const isPro = stableVideoOption.dataset.isPro === 'true';
            
            // Update selected UI
            document.querySelectorAll('.model-option').forEach(el => el.classList.remove('selected'));
            stableVideoOption.classList.add('selected');
            
            // Apply model settings
            selectModel(modelId, isPro, stableVideoOption);
            
            // Make sure image upload section is visible
            document.getElementById('imageUploadSection').style.display = 'block';
            
            // Set the image
            setReferenceImage(imageUrl).then(() => {
                // Scroll to the top of the form
                document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
            });
        } else {
            console.error('Could not find stable_video model option');
        }
    }
    
    // Function to download an asset
    function downloadAsset(assetId, assetUrl) {
        // Create a link and trigger download
        const downloadLink = document.createElement('a');
        downloadLink.href = "{{ url_for('user.asset_download', asset_id=0) }}".replace('0', assetId);
        downloadLink.download = `asset_${assetId}.${assetUrl.split('.').pop().split('?')[0]}`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
    
    // Function to delete an asset
    function deleteAsset(assetId, elementToRemove) {
        if (!confirm('Are you sure you want to delete this asset? This action cannot be undone.')) {
            return;
        }
        
        fetch(`/api/assets/${assetId}`, {
            method: 'DELETE',
        })
        .then(response => {
            if (response.ok) {
                // Remove the element from the DOM
                if (elementToRemove && elementToRemove.parentNode) {
                    elementToRemove.parentNode.removeChild(elementToRemove);
                }
            } else {
                alert('Failed to delete asset. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error deleting asset:', error);
            alert('An error occurred while deleting the asset.');
        });
    }
    
    // Function to show an error message
    function showError(message) {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = `
            <div class="error-message">
                ${message}
            </div>
        `;
    }
    
    // Function to show timeout retry message for video generation
    function showTimeoutRetryMessage(formData, modelId) {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = `
            <div class="timeout-retry-message">
                <div class="timeout-icon">⏱️</div>
                <h3>Video Generation Timed Out</h3>
                <p>Video generation is taking longer than expected. This can happen when the AI servers are busy.</p>
                <div class="retry-actions">
                    <button class="retry-btn" onclick="retryGeneration()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                    <button class="cancel-btn" onclick="cancelRetry()">
                        Cancel
                    </button>
                </div>
                <small>Tip: Video generation typically takes 1-3 minutes, but can take longer during peak hours.</small>
            </div>
        `;
        
        // Store form data for retry
        window.retryFormData = formData;
        window.retryModelId = modelId;
    }
    
    // Function to retry generation
    function retryGeneration() {
        if (window.retryFormData && window.retryModelId) {
            // Clear the retry message and restart generation
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';
            
            // Simulate form submission with stored data
            const generateEvent = new Event('submit', { bubbles: true, cancelable: true });
            
            // Store the retry data temporarily
            const form = document.getElementById('promptForm');
            const originalFormData = new FormData(form);
            
            // Trigger the generation process manually
            handleGeneration(window.retryFormData, window.retryModelId);
        }
    }
    
    // Function to cancel retry
    function cancelRetry() {
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = `
            <div class="no-results">
                Generation cancelled. Enter a prompt above and click "Generate" to create assets
            </div>
        `;
        
        // Clear retry data
        window.retryFormData = null;
        window.retryModelId = null;
    }
    
    // Extract generation logic for reuse
    async function handleGeneration(formData, modelId) {
        const resultsContainer = document.getElementById('results');
        const model = modelConfigs[modelId];
        
        // Get prompt for state tracking
        const promptElement = document.getElementById('prompt');
        const prompt = promptElement ? promptElement.value.trim() : '';
        
        // Determine number of outputs
        const numOutputs = (model && model.default_num_outputs) ? model.default_num_outputs : (modelId === 'stable_video' ? 1 : 4);
        
        // Start tracking this generation
        let requestId;
        try {
            requestId = stateManager.startGeneration({
                modelId: modelId,
                prompt: prompt,
                formData: formData,
                numOutputs: numOutputs
            });
            console.log(`[Dashboard] Started tracking generation ${requestId}`);
        } catch (error) {
            showError(error.message);
            return;
        }
        
        // Clear previous results
        resultsContainer.innerHTML = '';
        
        // Show loading indicators with enhanced progress for video generation
        for (let i = 0; i < numOutputs; i++) {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'image-result loading';
            loadingIndicator.setAttribute('data-generation-id', requestId);
            
            if (modelId === 'stable_video') {
                loadingIndicator.innerHTML = `
                    <div class="loading-spinner"></div>
                    <div class="loading-progress">
                        <div class="progress-text">Generating video...</div>
                        <div class="progress-subtext">This may take 2-3 minutes</div>
                        <div class="progress-timer" id="progress-timer-${i}">0s</div>
                    </div>
                `;
            } else {
                loadingIndicator.innerHTML = '<div class="loading-spinner"></div>';
            }
            
            resultsContainer.appendChild(loadingIndicator);
        }
        
        // Start timer for video generation
        let startTime = Date.now();
        let timerInterval;
        
        if (modelId === 'stable_video') {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const timerElement = document.getElementById('progress-timer-0');
                if (timerElement) {
                    timerElement.textContent = `${elapsed}s`;
                    
                    // Update progress text based on elapsed time
                    const progressText = document.querySelector('.progress-text');
                    const progressSubtext = document.querySelector('.progress-subtext');
                    
                    if (elapsed > 120) {
                        progressText.textContent = 'Still processing...';
                        progressSubtext.textContent = 'Video generation is taking longer than usual';
                    } else if (elapsed > 60) {
                        progressText.textContent = 'Processing video...';
                        progressSubtext.textContent = 'Almost done, please wait';
                    }
                }
            }, 1000);
        }
        
        try {
            console.log('Sending API request to /api/generate...');
            
            // Enhanced fetch with longer timeout for video generation
            const timeoutMs = modelId === 'stable_video' ? 300000 : 120000; // 5 minutes for video, 2 minutes for images
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            
            // Send request to server
            const response = await fetch('/api/generate', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            if (timerInterval) clearInterval(timerInterval);
            
            console.log('API response status:', response.status);
            const data = await response.json();
            console.log('API response data:', data);
            
            if (!response.ok) {
                // Update state manager with failure
                stateManager.updateGenerationStatus(requestId, 'failed');
                
                // Check if it's a timeout error and offer retry for video generation
                if (modelId === 'stable_video' && (data.error?.includes('timeout') || data.error?.includes('timed out'))) {
                    showTimeoutRetryMessage(formData, modelId);
                } else {
                    showError(data.error || 'An error occurred while generating content');
                    resultsContainer.innerHTML = '';
                }
                return;
            }
            
            // Mark generation as completed in state manager
            stateManager.completeGeneration(requestId, data.results);
            
            // Display results
            displayResults(data.results, modelId);
            
            // Clear retry data on success
            window.retryFormData = null;
            window.retryModelId = null;
            
        } catch (error) {
            if (timerInterval) clearInterval(timerInterval);
            
            console.error('Error generating content:', error);
            
            // Handle timeout specifically
            if (error.name === 'AbortError') {
                // Update state manager with timeout
                stateManager.updateGenerationStatus(requestId, 'timeout');
                
                if (modelId === 'stable_video') {
                    showTimeoutRetryMessage(formData, modelId);
                } else {
                    showError('Request timed out. Please try again.');
                    resultsContainer.innerHTML = '';
                }
            } else {
                // Update state manager with failure
                stateManager.updateGenerationStatus(requestId, 'failed');
                showError('An error occurred while generating content');
                resultsContainer.innerHTML = '';
            }
        }
    }

    // Debug helper: Add to window for console access
    window.clearGenerationState = function() {
        console.log('Clearing all generation state from localStorage...');
        localStorage.removeItem('ai_generator_state');
        console.log('Generation state cleared! Please refresh the page.');
    };

    console.log('Dashboard loaded. To clear stuck generation state, run: clearGenerationState()');
</script>
{% endblock %}